<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Petugas/Admin - Pelatihan Pembelajaran Mendalam</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;700&display=swap" rel="stylesheet">
</head>
<body>

    <div class="main-container">
        <!-- Tombol Kembali ke Halaman Utama -->
        <a href="index.html" class="back-link">‚Üê Kembali ke Halaman Utama</a>
        
        <!-- Kontainer Login dengan Efek Kaca -->
        <div class="form-container login-container">
            <header class="header-section">
                <h1>üîê Login Petugas/Admin</h1>
                <p>Akses khusus untuk petugas dan admin pelatihan</p>
            </header>

            <!-- Form Login -->
            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="password">Password Admin *</label>
                    <div class="password-input-group">
                        <input type="password" id="password" name="password" placeholder="Masukkan password yang diberikan" required>
                        <button type="button" class="toggle-password" onclick="togglePassword()">
                            üëÅÔ∏è
                        </button>
                    </div>
                </div>

                <!-- Captcha Sederhana -->
                <div class="form-group">
                    <label for="captcha">Verifikasi Keamanan *</label>
                    <div class="captcha-container">
                        <span id="captcha-text" class="captcha-text"></span>
                        <input type="text" id="captcha" name="captcha" placeholder="Masukkan angka di atas" required>
                        <button type="button" class="refresh-captcha" onclick="generateCaptcha()">
                            üîÑ
                        </button>
                    </div>
                </div>

                <!-- Tombol Submit -->
                <button type="submit" class="btn" id="login-btn">
                    üîë Masuk ke Sistem
                </button>
            </form>

            <!-- Status Login -->
            <div id="login-status" class="login-status" style="display: none;">
                <div id="status-message"></div>
            </div>

            <!-- Informasi Tambahan -->
            <div class="login-info">
                <p><strong>Info Login:</strong></p>
                <ul>
                    <li>Hanya petugas/admin dengan password khusus yang dapat mengakses</li>
                    <li>Password diberikan oleh superadmin</li>
                    <li>Session akan berakhir dalam 30 menit</li>
                    <li>Login otomatis jika session masih aktif</li>
                </ul>
                <p><a href="debug-password-simple.html" style="color: #fff; text-decoration: underline;">üîç Debug: Test password</a></p>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>Memverifikasi password...</p>
        </div>
    </div>

    <script>
        let captchaResult = 0;
        
        // Daftar password yang valid
        const validPasswords = {
            // Superadmin - Akses penuh untuk monitoring semua admin
            'superadmin': '@SUPER_ADMIN_2024',
            
            // Admin biasa - Akses terbatas
            'admin1': '@KS_Kab.Pasuruan_5',
            'admin2': '@KS_Kab.Pasuruan_6',
            'admin3': '@PAUD_Kab.Pasuruan_2',
            'admin4': '@PAUD-PNF_Kab.Pasuruan_1',
            'admin5': '@SD_Kab.Pasuruan_6',
            'admin6': '@SD_Kab.Pasuruan_7',
            'admin7': '@SD_Kab.Pasuruan_8'
        };

        // Check existing session saat halaman dimuat
        document.addEventListener('DOMContentLoaded', function() {
            generateCaptcha();
            checkExistingSession();
        });

        // Check apakah sudah ada session aktif
        function checkExistingSession() {
            const isLoggedIn = sessionStorage.getItem('admin_logged_in');
            const loginTime = sessionStorage.getItem('admin_login_time');
            const userRole = sessionStorage.getItem('admin_role');
            
            if (isLoggedIn && loginTime && userRole) {
                // Check apakah session masih valid
                const now = Date.now();
                const loginTimeNum = parseInt(loginTime);
                const sessionAge = (now - loginTimeNum) / 1000; // dalam detik
                const sessionDuration = 30 * 60; // 30 menit
                
                if (sessionAge < sessionDuration) {
                    // Session masih valid, redirect langsung ke dashboard
                    showStatus('‚úÖ Session masih aktif, mengalihkan ke dashboard...', 'success');
                    setTimeout(() => {
                        redirectToDashboard(userRole);
                    }, 1500);
                    return;
                } else {
                    // Session expired, clear dan minta login ulang
                    clearSession();
                }
            }
        }

        // Toggle password visibility
        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const toggleBtn = document.querySelector('.toggle-password');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleBtn.textContent = 'üôà';
            } else {
                passwordInput.type = 'password';
                toggleBtn.textContent = 'üëÅÔ∏è';
            }
        }

        // Generate captcha sederhana
        function generateCaptcha() {
            const num1 = Math.floor(Math.random() * 10) + 1;
            const num2 = Math.floor(Math.random() * 10) + 1;
            captchaResult = num1 + num2;
            
            document.getElementById('captcha-text').textContent = `${num1} + ${num2} = ?`;
            document.getElementById('captcha').value = '';
        }

        // Handle login form submission
        async function handleLogin(event) {
            event.preventDefault();
            
            const password = document.getElementById('password').value;
            const captcha = document.getElementById('captcha').value;
            const loginBtn = document.getElementById('login-btn');
            const loadingOverlay = document.getElementById('loading-overlay');

            // Validasi captcha
            if (parseInt(captcha) !== captchaResult) {
                showStatus('‚ùå Verifikasi keamanan salah! Silakan coba lagi.', 'error');
                generateCaptcha();
                return;
            }

            // Validasi input
            if (!password) {
                showStatus('‚ùå Mohon masukkan password!', 'error');
                return;
            }

            // Tampilkan loading
            loginBtn.disabled = true;
            loginBtn.textContent = '‚è≥ Memverifikasi...';
            loadingOverlay.style.display = 'flex';

            try {
                // Simulasi delay untuk keamanan
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Verifikasi password dan tentukan role
                const userRole = verifyPassword(password);
                
                if (userRole) {
                    showStatus('‚úÖ Login berhasil! Mengalihkan ke dashboard...', 'success');
                    
                    // Simpan session
                    sessionStorage.setItem('admin_logged_in', 'true');
                    sessionStorage.setItem('admin_password', password);
                    sessionStorage.setItem('admin_role', userRole);
                    sessionStorage.setItem('admin_login_time', Date.now().toString());
                    
                    // Redirect ke dashboard sesuai role
                    setTimeout(() => {
                        redirectToDashboard(userRole);
                    }, 2000);
                } else {
                    showStatus('‚ùå Password salah! Silakan coba lagi.', 'error');
                    generateCaptcha();
                }
            } catch (error) {
                console.error('Login error:', error);
                showStatus('‚ùå Terjadi kesalahan sistem. Silakan coba lagi.', 'error');
                generateCaptcha();
            } finally {
                // Reset loading state
                loginBtn.disabled = false;
                loginBtn.textContent = 'üîë Masuk ke Sistem';
                loadingOverlay.style.display = 'none';
            }
        }

        // Verifikasi password dan return role
        function verifyPassword(password) {
            for (const [role, pass] of Object.entries(validPasswords)) {
                if (pass === password) {
                    return role;
                }
            }
            return null;
        }

        // Redirect ke dashboard sesuai role
        function redirectToDashboard(role) {
            if (role === 'superadmin') {
                window.location.href = 'dashboard-superadmin.html';
            } else {
                window.location.href = 'dashboard-panitia.html';
            }
        }

        // Tampilkan status login
        function showStatus(message, type) {
            const statusDiv = document.getElementById('login-status');
            const statusMessage = document.getElementById('status-message');
            
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type}`;
            statusDiv.style.display = 'block';
            
            // Auto-hide setelah 5 detik
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Clear session
        function clearSession() {
            sessionStorage.removeItem('admin_logged_in');
            sessionStorage.removeItem('admin_password');
            sessionStorage.removeItem('admin_role');
            sessionStorage.removeItem('admin_login_time');
        }

        // Rate limiting untuk mencegah brute force
        let loginAttempts = 0;
        let lastAttemptTime = 0;
        
        function checkRateLimit() {
            const now = Date.now();
            if (now - lastAttemptTime < 5000) { // 5 detik
                loginAttempts++;
                if (loginAttempts > 3) {
                    showStatus('‚ö†Ô∏è Terlalu banyak percobaan login. Silakan tunggu 5 menit.', 'warning');
                    return false;
                }
            } else {
                loginAttempts = 1;
            }
            lastAttemptTime = now;
            return true;
        }
    </script>

</body>
</html>
